<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Gestão de Notas Fiscais UNA</title>
<style>
:root {
  --primary: #003c8f;
  --accent: #0277bd;
  --bg: #f4f0f8;
  --card: #fff;
  --text: #333;
}
*{box-sizing:border-box}
body{font-family:Arial,Helvetica,sans-serif;background-color:var(--bg);margin:0;color:var(--text)}
header{background-color:var(--primary);color:#fff;padding:20px;text-align:center;font-size:24px;font-weight:700}
nav{display:flex;justify-content:center;margin:20px 0;gap:12px;flex-wrap:wrap}
nav button{padding:10px 18px;font-size:15px;border:0;border-radius:8px;cursor:pointer;background-color:var(--accent);color:#fff;transition:transform .12s ease}
nav button.active,nav button:hover{background-color:var(--primary);transform:translateY(-1px)}
section{display:none;max-width:1200px;margin:12px auto;padding:18px;background:var(--card);border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
section.active{display:block}
table{width:100%;border-collapse:collapse;margin-top:18px;font-size:14px;min-width:900px}
th,td{border:1px solid #e6dff1;padding:10px;text-align:center;vertical-align:middle}
th{background:var(--primary);color:#fff}
tr:nth-child(even){background:#f9f9ff}
tr:hover{background:#eef4ff}
#paginationBar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-top:14px;flex-wrap:wrap}
.page-controls{display:flex;align-items:center;gap:8px}
.page-controls button{padding:6px 10px;border-radius:6px;border:0;background:var(--primary);color:#fff;cursor:pointer}
.page-controls button:disabled{background:#ddd;color:#666;cursor:not-allowed}
.page-numbers{display:flex;gap:6px;align-items:center;flex-wrap:wrap;max-width:60%}
.page-numbers button{padding:6px 10px;border-radius:6px;border:0;background:#eee;cursor:pointer}
.page-numbers button.active{background:var(--primary);color:#fff;font-weight:600}
#rowsPerPage{padding:6px;border-radius:6px}
@media (max-width:900px){table{font-size:13px;min-width:720px}}
#feedback{position:fixed;top:18px;right:18px;background:var(--primary);color:#fff;padding:10px 14px;border-radius:8px;display:none;box-shadow:0 10px 28px rgba(0,0,0,0.14)}
</style>
</head>
<body>

<header>Gestão de Notas Fiscais UNA</header>

<nav>
  <button id="btnView" class="active">Visualizar NFs</button>
</nav>

<section id="viewSection" class="active">
  <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
    <div style="flex:2; min-width:220px;">
      <label for="searchInput">Pesquisar:</label>
      <input type="text" id="searchInput" placeholder="Pesquise razão, NF..." oninput="aplicarFiltroPesquisa()">
    </div>
    <div style="min-width:100px;">
      <label>&nbsp;</label>
      <button onclick="carregarNFs()">Atualizar</button>
    </div>
  </div>

  <table id="nfTable" aria-live="polite">
    <thead>
      <tr>
        <th>Data/Hora</th>
        <th>Razão Social</th>
        <th>Nº NF Venda</th>
        <th>Nº NF Remessa</th>
        <th>Nº NF Cobertura</th>
        <th>Fábrica</th>
        <th>PDF</th>
        <th>Observação</th>
      </tr>
    </thead>
    <tbody><tr><td colspan="8" style="text-align:center;">Carregando...</td></tr></tbody>
  </table>

  <div id="paginationBar">
    <div class="page-controls">
      <button id="firstPageBtn" onclick="goToPage(1)">⟪ Primeiro</button>
      <button id="prevBtn" onclick="changePage(-1)">⟨ Voltar</button>
    </div>

    <div class="page-numbers" id="pageNumbers"></div>

    <div class="page-controls">
      <button id="nextBtn" onclick="changePage(1)">Avançar ⟩</button>
      <button id="lastPageBtn" onclick="goToLastPage()">Último ⟫</button>
    </div>

    <div style="display:flex; gap:8px; align-items:center;">
      <div>
        Mostrar
        <select id="rowsPerPage" onchange="changeRowsPerPage()">
          <option value="10">10</option>
          <option value="30">30</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
        por página
      </div>
      <div id="showingInfo" style="white-space:nowrap; font-size:13px; color:#333;"></div>
    </div>
  </div>
</section>

<div id="feedback">Operação realizada com sucesso!</div>

<script>
const webAppURL = "https://script.google.com/macros/s/AKfycbyPdj_FtFywyV4Ey4b3-Q6YV3RcgXzsEUux6ceK23cdJTh71paHQ9HMD5Ts-pFOomUX/exec";
let allData = [], workingData = [];
let currentPage = 1, rowsPerPage = 10;
const refs = {
  nfTableBody: document.querySelector('#nfTable tbody'),
  pageNumbers: document.getElementById('pageNumbers'),
  prevBtn: document.getElementById('prevBtn'),
  nextBtn: document.getElementById('nextBtn'),
  firstPageBtn: document.getElementById('firstPageBtn'),
  lastPageBtn: document.getElementById('lastPageBtn'),
  showingInfo: document.getElementById('showingInfo'),
  searchInput: document.getElementById('searchInput'),
  feedback: document.getElementById('feedback'),
  rowsPerPage: document.getElementById('rowsPerPage')
};

async function carregarNFs(){
  try{
    const res = await fetch(webAppURL + '?action=get');
    const data = await res.json();
    allData = Array.isArray(data) ? data.filter(r => r.fabrica === 'UNA') : [];
    allData.sort((a,b)=> new Date(b.dataHora||0) - new Date(a.dataHora||0));
    aplicarFiltroPesquisa();
  }catch(err){
    console.error(err);
    allData = [];
    aplicarFiltroPesquisa();
  }
}

function aplicarFiltroPesquisa(){
  const termo = refs.searchInput.value.toLowerCase().trim();
  workingData = termo 
    ? allData.filter(r => (r.razao + r.nfVenda + r.nfRemessa + r.observacao).toLowerCase().includes(termo))
    : allData;
  currentPage = 1;
  renderTabela();
}

function renderTabela(){
  const tbody = refs.nfTableBody;
  tbody.innerHTML = '';
  rowsPerPage = parseInt(refs.rowsPerPage.value,10) || 10;
  const totalItems = workingData.length;
  const totalPages = Math.max(1, Math.ceil(totalItems/rowsPerPage));
  if(currentPage > totalPages) currentPage = totalPages;
  const start = (currentPage-1)*rowsPerPage;
  const end = Math.min(totalItems, start+rowsPerPage);
  const pageData = workingData.slice(start, end);

  if(pageData.length === 0){
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Nenhuma NF encontrada.</td></tr>';
  } else {
    for(const r of pageData){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.dataHora ? new Date(r.dataHora).toLocaleString() : '-'}</td>
        <td>${r.razao || ''}</td>
        <td>${r.nfVenda || ''}</td>
        <td>${r.nfRemessa || ''}</td>
        <td>${r.nfCobertura || ''}</td>
        <td>${r.fabrica || ''}</td>
        <td>${r.pdfLink ? `<a href="${r.pdfLink}" target="_blank">Abrir PDF</a>` : '—'}</td>
        <td>${r.observacao || ''}</td>`;
      tbody.appendChild(tr);
    }
  }

  updatePaginationUI(totalItems, totalPages, start+1, end);
}

function updatePaginationUI(totalItems, totalPages, startIndex, endIndex){
  refs.pageNumbers.innerHTML = '';
  const maxButtons = 7;
  let startPage = Math.max(1, currentPage - Math.floor(maxButtons/2));
  let endPage = Math.min(totalPages, startPage + maxButtons - 1);
  if(endPage - startPage < maxButtons - 1) startPage = Math.max(1, endPage - maxButtons + 1);
  for(let p=startPage;p<=endPage;p++){
    const b = document.createElement('button');
    b.textContent = p;
    if(p===currentPage) b.classList.add('active');
    b.onclick = ()=>goToPage(p);
    refs.pageNumbers.appendChild(b);
  }
  refs.prevBtn.disabled = currentPage <= 1;
  refs.nextBtn.disabled = currentPage >= totalPages;
  refs.firstPageBtn.disabled = currentPage <= 1;
  refs.lastPageBtn.disabled = currentPage >= totalPages;
  refs.showingInfo.innerText = totalItems === 0 ? 'Mostrando 0 de 0' : `Mostrando ${startIndex}–${endIndex} de ${totalItems}`;
}

function changePage(dir){ const totalPages = Math.ceil(workingData.length/rowsPerPage); currentPage = Math.min(totalPages, Math.max(1, currentPage + dir)); renderTabela(); }
function goToPage(n){ const totalPages = Math.ceil(workingData.length/rowsPerPage); currentPage = Math.min(totalPages, Math.max(1, n)); renderTabela(); }
function goToLastPage(){ const totalPages = Math.ceil(workingData.length/rowsPerPage); currentPage = totalPages; renderTabela(); }
function changeRowsPerPage(){ rowsPerPage = parseInt(refs.rowsPerPage.value,10); currentPage = 1; renderTabela(); }

function mostrarFeedback(msg){
  refs.feedback.innerText = msg;
  refs.feedback.style.display = 'block';
  setTimeout(()=>refs.feedback.style.display='none',2000);
}

carregarNFs();
</script>
</body>
</html>
